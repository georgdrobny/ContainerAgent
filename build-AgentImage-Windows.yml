trigger: none

parameters:
- name: DownloadAgent
  displayName: Download and Install Latest Pipeline Agent
  type: boolean
  default: False
- name: AgentImage
  displayName: Pipeline Agent Image
  type: string
  default: windows-2019
  values:
    - windows-2019
    - windows-2022
- name: ContainerRegistry
  displayName: Container Registry Service Connection
  default: containeragent
  values:
    - containeragent
    - gdcontaineragent

variables:
  baseImageName: 'none'
  tag: 'none'
  agentPackage: 'none'
  imageRepository: 'pipeline-agent'
  containerRegistry: 'containeragent'
  sourceDir : '$(build.SourcesDirectory)\\windows\\'
  workingDir : '$(build.ArtifactStagingDirectory)\\agent\\'
  dockerfilePath: '$(build.ArtifactStagingDirectory)\\agent\\Dockerfile'
  download: $[${{ parameters.DownloadAgent }}]

jobs:
- job: 'BuildAgentImage'
  pool:
    vmImage: ${{ parameters.AgentImage }}
  steps:
  - pwsh: |
      $package = common/DownloadAgent.ps1 -AzureDevOpsOrganization $(AzureDevOpsOrganization) -AzureDevOpsPersonalAccessToken $(AzureDevOpsToken) -DestinationDirectory $(Build.ArtifactStagingDirectory)
      Write-Host "##vso[task.setvariable variable=agentPackage]$package"
    condition: eq(variables.download,true) 
    displayName: 'Download Agent Package'
  - pwsh: |
      switch ('${{ parameters.AgentImage }}') { `
        'windows-2019' { $baseImageName = 'mcr.microsoft.com/dotnet/framework/sdk:4.8-windowsservercore-ltsc2019'; break } `
        'windows-2022' { $baseImageName = 'mcr.microsoft.com/dotnet/framework/sdk:4.8-windowsservercore-ltsc2022'; break } `
      }
      "##vso[task.setvariable variable=baseImageName]$baseImageName"
      $tag = '${{ parameters.AgentImage }}'
      "##vso[task.setvariable variable=tag]$tag"      
      Write-Host "BaseImage: $(baseImageName) Tag: $(tag)"
    displayName: Selecting Agent Base Image
  - pwsh: |
      $tag = windows/BuildAgentImage.ps1 -WorkingDir $(workingDir) -SourceDir $(sourceDir) -AgentPackage $(agentPackage) -Tag $(tag)
      Write-Host "##vso[task.setvariable variable=tag]$tag"
    displayName: Prepare Windows Pipeline Agent Image
  - task: Docker@2
    displayName: Build Windows Pipeline Agent Image
    inputs:
      containerRegistry: ${{ parameters.ContainerRegistry }}
      repository: '$(imageRepository)'
      command: 'build'
      Dockerfile: $(dockerfilePath)
      tags: '$(tag)'
      arguments: '--build-arg BASE=$(baseImageName)'
  - task: Docker@2
    displayName: Push Windows Pipeline Agent Image
    inputs:
      containerRegistry: ${{ parameters.ContainerRegistry }}
      repository: '$(imageRepository)'
      command: 'push'
      tags: '$(tag)'
      addPipelineData: true
      
      